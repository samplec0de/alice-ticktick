name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run ruff check .
      - run: uv run ruff format --check .

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run mypy alice_ticktick/

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --extra dev
      - run: uv run pytest --cov=alice_ticktick --cov-report=xml -v
      - uses: codecov/codecov-action@v4
        if: always()
        with:
          file: coverage.xml

  deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [lint, typecheck, test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Package application
        run: bash scripts/package.sh

      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -n
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Authenticate with Yandex Cloud
        run: |
          echo '${{ secrets.YC_SA_KEY_JSON }}' > sa-key.json
          yc config set service-account-key sa-key.json
          yc config set folder-id ${{ vars.YC_FOLDER_ID }}
          rm sa-key.json

      - name: Upload to Object Storage
        run: |
          yc storage s3api put-object \
            --bucket alice-ticktick-deploy \
            --key deploy.zip \
            --body deploy.zip

      - name: Deploy to Yandex Cloud Functions
        run: |
          yc serverless function version create \
            --function-id ${{ vars.YC_FUNCTION_ID }} \
            --runtime python312 \
            --entrypoint alice_ticktick.main.handler \
            --memory 256m \
            --execution-timeout 7s \
            --package-bucket-name alice-ticktick-deploy \
            --package-object-name deploy.zip \
            --environment ALICE_SKILL_ID=${{ vars.ALICE_SKILL_ID }}
