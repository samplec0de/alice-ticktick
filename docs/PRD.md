# PRD: Алиса + TickTick

## Обзор продукта

**Название навыка:** ТикТик

**Активационное имя:** "ТикТик" (запуск: "Алиса, запусти навык ТикТик")

**Ограничения активационного имени Яндекс.Диалогов:**
- 2–4 слова (предлоги/союзы не считаются). "ТикТик" — 1 слово, но может пройти как 2 (тик + тик). Если нет — fallback: "ТикТик помощник"
- Запрещены: "Яндекс", "Алиса", "Станция", общеупотребительные команды, только категории
- Латиница запрещена — только кириллица или транслитерация
- Использование бренда требует подтверждения прав через Яндекс.Вебмастер. У нас прав на бренд TickTick нет — риск отклонения на модерации. Plan B: переименование в "ТикТик помощник" / "Тик планер" / другое

**Цель:** Полноценное голосовое управление задачами и привычками TickTick через Яндекс Алису — создание, редактирование, поиск, чеклисты, подзадачи, теги, kanban, привычки, статистика и голосовые брифинги.

**Целевая аудитория:** Русскоязычные пользователи TickTick, использующие Яндекс Алису (колонки, приложение, браузер).

**Статус:** В разработке

---

## Проблема

Управление задачами через мобильное приложение требует ручного ввода. Голосовое управление позволяет:
- Быстро добавить задачу "на ходу"
- Узнать план на день без открытия приложения
- Управлять чеклистами, подзадачами и привычками голосом
- Получать утренний/вечерний брифинг по задачам и продуктивности

---

## Платформенные ограничения

### Яндекс Алиса

| Ограничение | Значение | Влияние на дизайн |
|---|---|---|
| Таймаут webhook | 3 сек (целиться в <1.5 сек) | Кэширование, async, оптимизация запросов |
| Нет push-уведомлений | Навык не может инициировать диалог | Брифинги по запросу, напоминания через TickTick |
| State: session | 1 КБ | Только контекст текущего диалога |
| State: user | 1 КБ | Только OAuth-привязка и настройки |
| State: application | 1 КБ | Настройки устройства |
| response.text / tts | 1024 символа | Дробить длинные списки, пагинация |
| Screenless-устройства | Нет карточек на Яндекс.Станции | Весь контент должен быть доступен голосом |
| Account Linking | OAuth 2.0 Authorization Code | redirect_uri: social.yandex.net/broker/redirect |
| NLU | YANDEX.DATETIME, CONFIRM, REJECT, STRING, NUMBER | Использовать встроенные интенты + кастомные |

### TickTick API

| Возможность | V1 (Official, OAuth) | V2 (Unofficial, session) |
|---|---|---|
| Задачи CRUD | ✓ | ✓ |
| Проекты CRUD | ✓ | ✓ |
| Повторяющиеся задачи (repeatFlag RRULE) | ✓ | ✓ |
| Напоминания (reminders, iCal TRIGGER) | ✓ | ✓ |
| Чеклист-items внутри задачи | ✓ | ✓ |
| Теги | ✗ | ✓ |
| Привычки (Habits) | ✗ | ✓ |
| Kanban колонки | частично (/data) | ✓ |
| Подзадачи (parentId) | ✗ | ✓ |
| Batch-операции (до 100) | ✗ | ✓ |
| Статистика / Pomodoro | ✗ | ✓ |
| Rate limits | Не задокументированы, есть Retry-After | Не задокументированы |

**Архитектурное решение:** поддержка обоих API. V1 OAuth для авторизации и базовых операций. V2 для тегов, привычек, подзадач, kanban, статистики.

---

## Функциональные требования

### Фаза 1 — MVP: базовое управление задачами

#### FR-1: Авторизация пользователя
- OAuth 2.0 через Account Linking в Яндекс.Диалогах
- Привязка аккаунта TickTick к аккаунту Яндекс
- Проверка `meta.interfaces.account_linking` перед запросом авторизации
- Токен в `session.user.access_token`
- Graceful handling на устройствах без поддержки Account Linking

#### FR-2: Создание задачи
- **Команды:**
  - "Создай задачу [название]"
  - "Добавь задачу [название] в проект [проект]"
  - "Создай задачу [название] на [дата] с высоким приоритетом"
- **Слоты:** название (YANDEX.STRING), проект, дедлайн (YANDEX.DATETIME), приоритет
- **Подтверждение:** переспрос перед созданием для валидации распознанного
- **Примеры:**
  - "Создай задачу купить молоко"
  - "Добавь задачу в проект Работа подготовить отчёт до пятницы"
  - "Создай срочную задачу позвонить врачу на завтра"

#### FR-3: Просмотр задач на произвольную дату
- **Команды:**
  - "Какие задачи на сегодня?" / "Что у меня на сегодня?"
  - "Что на завтра?"
  - "Какие задачи на пятницу?" / "Что запланировано на 5 марта?"
  - "Покажи задачи на эту неделю"
- **Ответ:** список задач с приоритетами, до 5 голосом + пагинация ("Ещё?")
- **При пустом списке:** "На [дата] задач нет."
- **Парсинг дат:** "послезавтра", "в пятницу", "через неделю", "5 марта" через YANDEX.DATETIME

#### FR-4: Просмотр просроченных задач
- **Команда:** "Какие задачи просрочены?" / "Что я пропустил?"
- **Ответ:** список просроченных задач с количеством дней просрочки

#### FR-5: Завершение задачи
- **Команда:** "Отметь задачу [название] выполненной" / "Готово [название]"
- **Подтверждение через YANDEX.CONFIRM** при неоднозначном совпадении

#### FR-6: Приоритеты
- **Команды:**
  - "Установи высокий приоритет для задачи [название]"
  - "Покажи срочные задачи"
- **Маппинг:** нет → 0, низкий → 1, средний → 3, высокий → 5

### Фаза 2 — Поиск и редактирование

#### FR-7: Нечёткий поиск задач
- **Команда:** "Найди задачу [запрос]"
- **Реализация:**
  - Сначала поиск через TickTick API (`search_tasks`)
  - Дополнительно: нечёткий поиск (Levenshtein / fuzzywuzzy / rapidfuzz) на стороне сервера
  - Поддержка смешанного рус/англ текста и спецсимволов в названиях задач
  - Транслитерация: "moloko" → "молоко" и наоборот
  - Нормализация: удаление символов, приведение к нижнему регистру
  - Fuzzy matching по токенам (token_sort_ratio) для устойчивости к перестановке слов
- **Ответ:** до 5 результатов голосом с возможностью уточнения
- **При нескольких совпадениях:** "Нашла несколько задач. Какую вы имеете в виду?"

#### FR-8: Редактирование задачи
- **Команды:**
  - "Перенеси задачу [название] на завтра"
  - "Поменяй приоритет задачи [название] на высокий"
  - "Переименуй задачу [название] в [новое название]"
- **Подтверждение:** переспрос перед изменением

#### FR-9: Удаление задачи
- **Команда:** "Удали задачу [название]"
- **Обязательное подтверждение** через YANDEX.CONFIRM/REJECT

### Фаза 3 — Подзадачи и чеклисты

#### FR-10: Управление подзадачами (V2 API)
- **Команды:**
  - "Добавь подзадачу [название] к задаче [родитель]"
  - "Покажи подзадачи задачи [название]"
  - "Отметь подзадачу [название] выполненной"
- **Поведение:** подзадача через `parentId` в том же проекте

#### FR-11: Чеклисты в задаче (items)
- **Команды:**
  - "Добавь пункт [текст] в чеклист задачи [название]"
  - "Покажи чеклист задачи [название]"
  - "Отметь пункт [текст] в чеклисте задачи [название]"
  - "Удали пункт [текст] из чеклиста задачи [название]"
- **Ответ при просмотре:** "Чеклист задачи Покупки: выполнено — хлеб; не выполнено — молоко, яйца"
- **Реализация:** поле `items[]` объекта задачи, каждый item: `{id, title, status(0|1), startDate, sortOrder}`

### Фаза 4 — Теги, повторяющиеся задачи, напоминания

#### FR-12: Управление тегами (V2 API)
- **Команды:**
  - "Добавь тег [тег] к задаче [название]"
  - "Убери тег [тег] с задачи [название]"
  - "Покажи задачи с тегом [тег]"
- **Реализация:** V2 `/batch/tag` + поле `tags[]` в задаче

#### FR-13: Повторяющиеся задачи
- **Команды:**
  - "Создай задачу [название] каждый день / каждую неделю / каждый месяц"
  - "Напоминай каждый понедельник проверить отчёт"
- **Реализация:** поле `repeatFlag` в формате RRULE (RFC 5545)
  - `FREQ=DAILY` — каждый день
  - `FREQ=WEEKLY;BYDAY=MO` — каждый понедельник
  - `FREQ=MONTHLY;BYMONTHDAY=15` — 15-го каждого месяца
- **Парсинг:** из естественного языка в RRULE

#### FR-14: Напоминания
- **Команды:**
  - "Напомни о задаче [название] за час"
  - "Поставь напоминание на задачу [название]"
- **Реализация:** поле `reminders[]` в формате iCal TRIGGER
  - `TRIGGER:-PT0S` — в момент дедлайна
  - `TRIGGER:-PT10M` — за 10 минут
  - `TRIGGER:-PT1H` — за час
  - `TRIGGER:-P1D` — за день
- **Важно:** Алиса НЕ отправляет push. Напоминание ставится в TickTick, уведомление придёт в приложении TickTick.

#### FR-15: Фильтрация задач
- **Команды:**
  - "Покажи все задачи с высоким приоритетом на этой неделе"
  - "Какие задачи с тегом работа просрочены?"
- **Комбинирование фильтров:** дата + приоритет + тег + проект

### Фаза 5 — Kanban и проекты

#### FR-16: Работа с Kanban (V2 API)
- **Команды:**
  - "Покажи доску [название проекта]"
  - "Что в колонке In Progress?"
  - "Перемести задачу [название] в In Progress"
- **Реализация:** V2 `/column/project/{projectId}` для получения колонок
- **Ответ:** "Доска Работа: в To Do — 3 задачи, в In Progress — 2, в Done — 5"

#### FR-17: Управление проектами
- **Команды:**
  - "Какие у меня проекты?"
  - "Покажи задачи из проекта [название]"
  - "Создай проект [название]"

### Фаза 6 — Привычки и статистика

#### FR-18: Привычки (V2 API)
- **Команды:**
  - "Покажи мои привычки"
  - "Я сделал медитацию" / "Отметь привычку [название]"
  - "Я забыл отметить [привычку] вчера" (backdating через checkinStamp)
  - "Какая у меня серия по [привычке]?"
- **Реализация:**
  - `GET /habits` — список привычек
  - `POST /habitCheckins/batch` — отметка выполнения (поддержка backdating)
  - `POST /habitCheckins/query` — данные о сериях
- **Типы привычек:** Boolean ("сделал/не сделал") и Numeric ("30 минут бега")

#### FR-19: Статистика продуктивности (V2 API)
- **Команды:**
  - "Как у меня дела сегодня?"
  - "Сколько задач я выполнил?"
  - "Какой у меня уровень продуктивности?"
- **Реализация:** V2 `GET /statistics/general` → score, level, tasks_completed_today
- **Данные фокуса:** V2 `/pomodoros/statistics/dist/{from}/{to}`

#### FR-20: Утренний / вечерний брифинг
- **Команды:**
  - "Доброе утро" / "Что у меня на сегодня?"
  - "Подведи итоги дня"
- **Утренний брифинг:**
  - Задачи на сегодня (количество и список)
  - Просроченные задачи (если есть)
  - Привычки на сегодня
- **Вечерний брифинг:**
  - Сколько задач выполнено
  - Серии привычек
  - Задачи на завтра (preview)
- **Замена push-уведомлениям:** пользователь сам инициирует брифинг

---

## Нефункциональные требования

### NFR-1: Производительность
- Время ответа webhook < 1.5 секунды (таймаут Алисы — 3 сек)
- Кэширование списка проектов пользователя (в памяти, TTL ~5 минут)
- Async HTTP-клиент для параллельных запросов к TickTick
- Batch API (V2) для множественных операций

### NFR-2: Безопасность
- Токены TickTick хранятся зашифрованно
- V2 session credentials: отдельное безопасное хранилище
- Валидация входящих запросов от Алисы
- Нет хранения голосовых данных
- Нет хранения паролей в открытом виде

### NFR-3: Масштабируемость
- Stateless webhook (горизонтальное масштабирование)
- Асинхронная обработка запросов к TickTick API
- Готовность к деплою в Yandex Cloud Functions

### NFR-4: Локализация
- Весь интерфейс на русском языке
- Поддержка русских дат через YANDEX.DATETIME: "послезавтра", "в пятницу", "через неделю", "5 марта"
- Корректная обработка русской морфологии: склонение числительных ("1 задача", "2 задачи", "5 задач")
- TTS: корректные ударения через `+` в критичных словах

### NFR-5: Нечёткий поиск
- Levenshtein distance / rapidfuzz для fuzzy matching
- Поддержка смешанного рус/англ текста
- Нормализация: удаление спецсимволов, приведение регистра
- Транслитерация рус↔англ
- Token sort ratio для устойчивости к перестановке слов
- Порог совпадения: настраиваемый (по умолчанию ~70%)

### NFR-6: Screenless-first дизайн
- Все ответы самодостаточны без экрана
- Карточки (BigImage, ItemsList) — дополнение, не замена тексту
- Кнопки-подсказки дублируют голосовые команды
- Пагинация через диалог ("Ещё?"), не через скролл

### NFR-7: Максимальное покрытие TickTick API
- Задачи: CRUD, завершение, поиск, фильтрация по дате/приоритету/тегу
- Подзадачи: создание, завершение (V2)
- Чеклисты (items): добавление, отметка, удаление
- Теги: добавление, удаление, фильтрация (V2)
- Повторяющиеся задачи: RRULE
- Напоминания: iCal TRIGGER
- Kanban: просмотр колонок, перемещение задач (V2)
- Привычки: просмотр, отметка, серии, backdating (V2)
- Статистика: продуктивность, pomodoro (V2)
- Проекты: CRUD, список

---

## Технический стек

| Компонент | Технология | Обоснование |
|-----------|------------|-------------|
| Язык | Python 3.12+ | Экосистема для NLP, асинхронность |
| Фреймворк Алисы | aliceio | Современный, aiogram-стиль, FSM, роутеры, Yandex Cloud Functions |
| HTTP-клиент | httpx (async) | Async, поддержка HTTP/2 |
| Нечёткий поиск | rapidfuzz | Быстрый fuzzy matching, Levenshtein |
| Парсинг дат | YANDEX.DATETIME (NLU) + dateparser (fallback) | Русские даты из естественного языка |
| Тесты | pytest + pytest-asyncio + pytest-cov | Стандарт, async, покрытие |
| CI/CD | GitHub Actions | Бесплатно для публичных репо |
| Деплой | Yandex Cloud Functions | Нативная интеграция, serverless |
| Линтер | ruff | Быстрый, всё-в-одном |
| Типизация | mypy | Статическая проверка типов |
| Менеджер зависимостей | uv | Быстрый, современный |

---

## Архитектура

```
┌─────────────┐     HTTPS POST      ┌──────────────────┐     HTTPS      ┌─────────────┐
│  Яндекс     │ ──────────────────> │  Webhook Server  │ ─────────────> │  TickTick   │
│  Алиса      │ <────────────────── │  (Python/aliceio)│ <───────────── │  API v1+v2  │
└─────────────┘     JSON Response   └──────────────────┘                └─────────────┘
                                      │              │
                                      │              │
                                ┌─────┴────┐   ┌────┴──────┐
                                │  Token   │   │  Fuzzy    │
                                │  Storage │   │  Search   │
                                └──────────┘   └───────────┘
```

### Модули

```
alice_ticktick/
├── __init__.py
├── main.py                  # Точка входа, webhook handler
├── alice/
│   ├── __init__.py
│   ├── models.py            # Pydantic-модели запросов/ответов Алисы
│   ├── cards.py             # Построение карточек (BigImage, ItemsList)
│   ├── middleware.py        # Валидация, логирование, auth-check
│   └── plurals.py           # Склонение: "1 задача", "2 задачи", "5 задач"
├── dialogs/
│   ├── __init__.py
│   ├── router.py            # Маршрутизация интентов (aliceio Router)
│   ├── intents.py           # Кастомные интенты и слоты
│   ├── states.py            # FSM-состояния диалогов
│   ├── scenes/
│   │   ├── __init__.py
│   │   ├── welcome.py       # Приветствие, помощь
│   │   ├── create_task.py   # Создание задачи (многоходовый диалог)
│   │   ├── list_tasks.py    # Просмотр задач на дату
│   │   ├── overdue_tasks.py # Просроченные задачи
│   │   ├── search_tasks.py  # Нечёткий поиск
│   │   ├── edit_task.py     # Редактирование
│   │   ├── delete_task.py   # Удаление с подтверждением
│   │   ├── subtasks.py      # Подзадачи
│   │   ├── checklist.py     # Чеклисты
│   │   ├── tags.py          # Теги
│   │   ├── recurrence.py    # Повторяющиеся задачи
│   │   ├── reminders.py     # Напоминания
│   │   ├── kanban.py        # Kanban-доска
│   │   ├── projects.py      # Проекты
│   │   ├── habits.py        # Привычки
│   │   ├── stats.py         # Статистика продуктивности
│   │   └── briefing.py      # Утренний/вечерний брифинг
│   └── nlp/
│       ├── __init__.py
│       ├── dates.py         # Парсинг дат (YANDEX.DATETIME + fallback)
│       ├── priorities.py    # "высокий" → 5, "срочный" → 5
│       ├── recurrence.py    # "каждый понедельник" → RRULE
│       └── fuzzy.py         # Нечёткий поиск (rapidfuzz, транслит)
├── ticktick/
│   ├── __init__.py
│   ├── client_v1.py         # Async клиент Official API v1
│   ├── client_v2.py         # Async клиент Unofficial API v2
│   ├── client.py            # Фасад: объединение v1 + v2
│   ├── models.py            # Pydantic-модели (Task, Project, Habit, Column, Tag)
│   └── auth.py              # OAuth flow + V2 session
├── storage/
│   ├── __init__.py
│   └── tokens.py            # Хранение и шифрование токенов
├── config.py                # Конфигурация (pydantic-settings)
└── utils.py                 # Общие утилиты
```

---

## Сценарии диалогов

### Приветствие (новая сессия)

```
Алиса:        "Привет! Я помогу управлять задачами в TickTick.
               Скажите «что на сегодня», «создай задачу» или «помощь»."
```

### Создание задачи

```
Пользователь: "Создай задачу купить продукты завтра"
Алиса:        "Создать задачу «Купить продукты» на завтра, 1 марта?"
Пользователь: "Да"
Алиса:        "В какой проект?"
Пользователь: "Личное"
Алиса:        "Готово! Задача «Купить продукты» добавлена в «Личное» на 1 марта."
```

### Просмотр задач на произвольную дату

```
Пользователь: "Что у меня на пятницу?"
Алиса:        "На пятницу, 6 марта, 4 задачи. Первые три:
               1. Подготовить презентацию — высокий приоритет
               2. Встреча с клиентом
               3. Отправить отчёт
               Показать остальные?"
Пользователь: "Да"
Алиса:        "4. Купить билеты. Это все задачи на пятницу."
```

### Нечёткий поиск

```
Пользователь: "Найди задачу про отчот"     (опечатка: "отчот" вместо "отчёт")
Алиса:        "Нашла похожую задачу: «Подготовить отчёт» в проекте «Работа»,
               дедлайн — пятница. Это та задача?"
```

### Чеклист

```
Пользователь: "Добавь пункт молоко в чеклист задачи купить продукты"
Алиса:        "Добавила «Молоко» в чеклист. Сейчас 3 пункта. Добавить ещё?"
Пользователь: "Покажи чеклист"
Алиса:        "Чеклист задачи «Купить продукты»:
               Выполнено — хлеб.
               Не выполнено — молоко, яйца."
```

### Подзадачи

```
Пользователь: "Добавь подзадачу написать введение к задаче подготовить отчёт"
Алиса:        "Создала подзадачу «Написать введение» для «Подготовить отчёт»."
```

### Теги

```
Пользователь: "Покажи задачи с тегом срочно"
Алиса:        "С тегом «срочно» 2 задачи:
               1. Оплатить счёт — до завтра
               2. Отправить документы — просрочена на 2 дня."
```

### Повторяющаяся задача

```
Пользователь: "Создай задачу проверять почту каждый будний день"
Алиса:        "Создать повторяющуюся задачу «Проверять почту»
               каждый будний день, с понедельника по пятницу?"
Пользователь: "Да"
Алиса:        "Готово! Задача будет повторяться по будням."
```

### Привычки

```
Пользователь: "Я сделал медитацию"
Алиса:        "Отметила привычку «Медитация» за сегодня.
               Серия: 5 дней подряд! Так держать!"

Пользователь: "Я забыл отметить бег вчера"
Алиса:        "Отметить привычку «Бег» за вчера?"
Пользователь: "Да"
Алиса:        "Готово! Серия по бегу: 3 дня."
```

### Kanban

```
Пользователь: "Покажи доску проекта Работа"
Алиса:        "Доска «Работа»:
               To Do — 3 задачи,
               In Progress — 2 задачи,
               Done — 5 задач.
               Какую колонку показать подробнее?"
```

### Утренний брифинг

```
Пользователь: "Доброе утро"
Алиса:        "Доброе утро! Вот ваш план на сегодня:
               4 задачи, 1 с высоким приоритетом.
               2 просроченные задачи.
               Привычки на сегодня: медитация, бег, чтение.
               Рассказать подробнее о задачах?"
```

### Статистика

```
Пользователь: "Как у меня дела?"
Алиса:        "Сегодня вы выполнили 5 задач.
               Серия медитации — 12 дней.
               Уровень продуктивности — 85."
```

---

## Метрики успеха

| Метрика | Цель |
|---------|------|
| Успешность распознавания интента | > 90% |
| Время ответа (p95) | < 1.5 сек |
| Точность нечёткого поиска | > 85% |
| Retention (7 дней) | > 30% |
| Оценка в каталоге Алисы | > 4.0 |
| Покрытие TickTick API | > 80% основных операций |

---

## Ограничения и риски

| Риск | Влияние | Митигация |
|------|---------|-----------|
| TickTick API v2 неофициальный, может сломаться | Высокое | Абстракция клиента, мониторинг, fallback на V1 |
| Алиса плохо распознаёт названия задач | Среднее | Подтверждение, fuzzy matching, переспрос |
| Нет push-уведомлений в Алисе | Высокое | Брифинги, напоминания в TickTick-приложении |
| OAuth flow сложен для пользователей | Среднее | Пошаговая инструкция, fallback |
| Таймаут 3 сек от Алисы | Среднее | Кэширование, async, batch API, оптимизация |
| Сложные составные команды плохо распознаются | Среднее | Многоходовые диалоги, уточняющие вопросы |
| 1024 символа — мало для длинных списков | Среднее | Пагинация, краткие формулировки |
| V2 session auth для публичного навыка | Высокое | Прокси-авторизация, исследование OAuth scope |
| Смешанный рус/англ текст в задачах | Среднее | rapidfuzz + транслитерация + нормализация |

---

## Roadmap

| Фаза | Содержание | Приоритет |
|------|------------|-----------|
| 0 | Инфраструктура: CI/CD, линтинг, тесты, структура проекта, aliceio scaffold | P0 |
| 1 | MVP: авторизация, создание задач, просмотр (сегодня/завтра/дата), просроченные, приоритеты | P0 |
| 2 | Нечёткий поиск, редактирование, удаление задач | P0 |
| 3 | Подзадачи и чеклисты | P1 |
| 4 | Теги, повторяющиеся задачи, напоминания, фильтрация | P1 |
| 5 | Kanban и проекты | P1 |
| 6 | Привычки, статистика, брифинги | P2 |
| 7 | Публикация в каталоге Алисы | P2 |
